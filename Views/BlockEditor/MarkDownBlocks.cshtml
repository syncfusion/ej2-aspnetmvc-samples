@using Syncfusion.EJ2
@using Syncfusion.EJ2.Navigations
@using Syncfusion.EJ2.BlockEditor
@{
    var treeData = (IEnumerable<object>)ViewData["TreeData"];
    var breadcrumbItems = (List<BreadcrumbItem>)ViewData["BreadcrumbItems"];
    var sidebarAttrs = (IDictionary<string, object>)ViewData["SidebarHtmlAttributes"];
}
@section ControlsSection {
    <div class="control-section blockeditor-marked">
        <!-- Sidebar: TOC / TreeView -->
        @{ Html.EJS().Sidebar("sidebar-treeview")
                 .EnableDock(true)
                 .Width("220px")
                 .EnableGestures(false)
                 .DockSize("33px")
                 .MediaQuery("(min-width: 600px)")
                 .Target(".blockeditor-marked")
                 .IsOpen(false)
                 .ContentTemplate(@<div>
    <div class="sidebar-header">
        <span>@(ViewBag.SidebarHeaderText as string)</span>
    </div>
    <div class="sb-rightpane-collapsed">
        <div class="labelchoose">Markdown Templates</div>
    </div>
    <div class="main-menu">
        @Html.EJS().Button("left-toc-closebtn").CssClass("e-icons e-chevron-left e-btn e-round closebutton").Content("").Render()
        @Html.EJS().TreeView("main-treeview").Fields(new TreeViewFieldsSettings
        {
            DataSource = ViewData["TreeData"],
            Id = "id",
            Text = "name",
            Child = "children",
            Selected = "selected",
            Expanded = "expanded"
        }).Render()
    </div>
</div>)
.HtmlAttributes((IDictionary<string, object>)ViewData["SidebarHtmlAttributes"])
.Render();
        }
        <!-- Content -->
        <div id="content_container" class="block-content">
            <div class="stick">
                <!-- Hidden element templates (actual components rendered here) -->
                <div id="tb-left" class="tb-template-host" style="display:none;">
                    <div class="breadcrumbcontent">
                        @Html.EJS().Breadcrumb("mk-breadcrumb").Items(breadcrumbItems).SeparatorTemplate("<span class='e-icons e-chevron-right'></span>").Render()
                    </div>
                </div>

                <div id="tb-right" class="tb-template-host" style="display:none;">
                    @Html.EJS().Button("download").CssClass("e-btn downloadbutton").IconCss("e-icons e-download").Render()
                </div>

                <!-- Render an empty Toolbar; we'll inject items in script -->
                @Html.EJS().Toolbar("mk-toolbar").Render()
            </div>

            <div class="markeditor">
                @Html.EJS().BlockEditor("mk-blockeditor").Height("602px").CommandMenuSettings((CommandMenuSettings)ViewData["CommandMenuSettings"]).InlineToolbarSettings((InlineToolbarSettings)ViewData["InlineToolbarSettings"]).Render()
            </div>

        </div>
    </div>
}

@section scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.2/marked.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/turndown/7.1.2/turndown.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script>
    // Server data (MVC)
    const TREE_DATA = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewData["TreeData"]));
    const INITIAL_LOAD_PATH = '@(ViewBag.InitialMdPath as string)'.replace(/&amp;/g, '&');
    const TEAM_SESSIONS_PATH = '@(ViewBag.TeamSessionsMdPath as string)'.replace(/&amp;/g, '&');

    // IDs
    const ids = {
        sidebar: 'sidebar-treeview',
        tree: 'main-treeview',
        editor: 'mk-blockeditor',
        breadcrumb: 'mk-breadcrumb',
        closeBtn: 'left-toc-closebtn',
        downloadBtn: 'download'
    };

    // Resolve EJ2 instances (components should exist now)
    const sb = ej.base.getComponent(document.getElementById(ids.sidebar), 'sidebar');
    const tv = ej.base.getComponent(document.getElementById(ids.tree), 'treeview');
    const be = ej.base.getComponent(document.getElementById(ids.editor), 'blockeditor');
    const bc = ej.base.getComponent(document.getElementById(ids.breadcrumb), 'breadcrumb');

    // Initialize Toolbar items from hidden element templates
    const tb = ej.base.getComponent(document.getElementById('mk-toolbar'), 'toolbar');
    if (tb) {
        tb.items = [
            { type: 'Separator' },
            { align: 'Left', template: '#tb-left' },
            { align: 'Right', template: '#tb-right' }
        ];
        tb.dataBind();
    }

    // Breadcrumb helpers
    function setBreadcrumb(items) {
        if (!bc) return;
        bc.items = items || [];
        bc.dataBind();
    }
    function formatBreadcrumbText(name) {
        return name ? name.replace(/\.md$/i, '') : '';
    }

    // Load Markdown -> HTML -> Blocks
    async function loadContent(mdFile) {
        try {
            //const resolved = normalizeUrl(mdFile);
            const url = encodeURI(mdFile);
            const res = await fetch(url, { cache: 'no-cache' });
            const md = await res.text();
            const html = window.marked.parse(md);
            if (!be) return;
            try {
                const nodeDatas = be.parseHtmlToBlocks(html);
                be.renderBlocksFromJson(nodeDatas, true);
            } catch (parseErr) {
                renderFallbackBlocks(`Parsed content from ${mdFile} failed.`);
            }
        } catch (err) {
            renderFallbackBlocks(`Error loading ${mdFile}. Ensure the file exists under Content/... and .md MIME is enabled.`);
        }
    }
    function renderFallbackBlocks(message) {
        if (!be) return;
        const blocks = [{
            id: 'fallback-block',
            type: 'Paragraph',
            content: [{ id: 'fallback-t', type: 'Text', content: message }],
            props: { placeholder: 'Fallback content' },
            indent: 0
        }];
        be.renderBlocksFromJson(blocks, true);
    }

    // TreeView selection (no globals)
    if (tv) {
        tv.nodeSelected = function (args) {
            const node = args.nodeData;
            if (!node) return;

            const id = node.id;
            if (id === 'Team Sessions') {
                setBreadcrumb([{ text: 'Team' }, { text: 'Team Sessions' }]);
                loadContent(TEAM_SESSIONS_PATH);
                return;
            }

            function findNodeById(arr, nid) {
                for (const n of arr) {
                    if (n.id === nid) return n;
                    if (n.children && n.children.length) {
                        const f = findNodeById(n.children, nid);
                        if (f) return f;
                    }
                }
                return null;
            }

            const selectedNode = findNodeById(TREE_DATA, id);
            if (selectedNode && selectedNode.mdFile) {
                loadContent(selectedNode.mdFile);
                const parentId = node.parentID;
                const bcItems = parentId === 'Team Sessions'
                    ? [{ text: 'Team' }, { text: 'Team Sessions' }, { text: formatBreadcrumbText(selectedNode.name) }]
                    : [{ text: 'Team' }, { text: formatBreadcrumbText(selectedNode.name) }];
                setBreadcrumb(bcItems);
            }
        };
        tv.dataBind();
    }

    // Sidebar functional behavior (CSS handles close button position)
    if (sb) {
        sb.open = function () {
            if (tv) { try { tv.expandAll(); } catch (_) {} }
        };
        sb.dataBind();
    }

    // Toggle sidebar via round button
    document.addEventListener('click', function (e) {
        if (e.target && e.target.id === ids.closeBtn) {
            if (sb) sb.toggle();
        }
    });

    // Download Markdown click
    const turndownService = window.TurndownService ? new TurndownService() : null;
        document.getElementById('download').onclick = function () {
            if (!be || !turndownService) {
                return;
            }
            let html = '';
            try { html = be.getDataAsHtml(); } catch (ex) { return; }
            const md = turndownService.turndown(html || '');
            let name = 'document';
            if (bc && bc.items && bc.items.length) {
                const last = bc.items[bc.items.length - 1].text || 'document';
                name = (last + '').replace(/[\\/:*?"<>|]+/g, '').trim() || 'document';
            }
            const fileName = name + '.md';
            const blob = new Blob([md], { type: 'text/markdown;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            try { a.href = url; a.download = fileName; document.body.appendChild(a); a.click(); }
            finally { document.body.removeChild(a); URL.revokeObjectURL(url); }
        }

    // Initial content load
    if (be && INITIAL_LOAD_PATH) {
        loadContent(INITIAL_LOAD_PATH);
        setBreadcrumb([{ text: 'Team' }, { text: 'Team Sessions' }]);
    }
    </script>
}
<style>
    /* Sidebar container styling */
    .blockeditor-marked .sidebar-content {
        overflow: visible;
        margin-top: 20px;
        border: 1px solid #dee2e6;
        height: 95%;
    }

    .blockeditor-marked {
        height: 680px;
        overflow: hidden;
    }

        .blockeditor-marked .block-content {
            border: 1px solid #dee2e6;
            border-left: none;
        }

        .blockeditor-marked .main-menu .e-list-parent.e-ul {
            overflow: hidden;
        }

        .blockeditor-marked .block-content .downloadbutton {
            box-shadow: none;
            margin-right: 10px;
        }

        .blockeditor-marked .e-sidebar.e-left.e-transition.e-close {
            transition: transform 2.5s ease, visibility 1200ms;
        }

        /* Close-button base styles */
        .blockeditor-marked .sidebar-content .main-menu .closebutton {
            position: fixed;
            width: 30px;
            height: 30px;
            border-radius: 100%;
            z-index: 9;
            display: flex;
            align-items: center;
            top: 28px;
            cursor: pointer;
        }

    /* Position/rotate icon purely via Sidebar state (no JS) */
    #sidebar-treeview:not(.e-close) .closebutton {
        left: 202px; /* Expanded */
        transform: none;
    }

    #sidebar-treeview.e-close .closebutton {
        left: 18px; /* Collapsed/docked */
        transform: rotate(180deg);
    }

    /* Show/hide TreeView based on Sidebar state (no JS) */
    #sidebar-treeview.e-close #main-treeview {
        display: none;
    }

    #sidebar-treeview:not(.e-close) #main-treeview {
        display: block;
    }

    .blockeditor-marked .sidebar-content .main-menu #main-treeview {
        border: none;
    }

    .blockeditor-marked .sb-rightpane-collapsed {
        width: 33px;
        height: 200px;
        position: absolute;
        z-index: 1001;
        pointer-events: none;
    }

        .blockeditor-marked .sb-rightpane-collapsed .labelchoose {
            transform: translate(-50%,-50%) rotate(-90deg);
            margin-top: 190px;
            margin-left: 16px;
            white-space: nowrap;
            font-size: 14px;
            pointer-events: none;
        }

    .blockeditor-marked .block-content .e-breadcrumb {
        pointer-events: none;
    }

    .blockeditor-marked .block-content .stick {
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .blockeditor-marked .stick .block-content .e-chevron-right {
        font-size: 10px;
    }

    .blockeditor-marked .e-content-animation {
        transition: none;
        transform: none;
    }

    .blockeditor-marked .sidebar-content .sidebar-header {
        background-color: #f8f9fa;
        padding: 12px 16px;
        border-bottom: 1px solid #dee2e6;
        z-index: 8;
        font-size: 14px;
        font-weight: 600;
        color: #495057;
        user-select: none;
        height: 44px;
        display: flex;
        align-items: center;
    }

    body[class*="dark"] .blockeditor-marked .sidebar-content .sidebar-header,
    body[class*="high"] .blockeditor-marked .sidebar-content .sidebar-header {
        background-color: unset;
        color: unset;
    }

        .blockeditor-marked .sidebar-content .sidebar-header span {
            pointer-events: none;
        }

    .blockeditor-marked #sidebar-treeview.e-dock.e-close .sidebar-header {
        display: none;
    }

    .blockeditor-marked #sidebar-treeview:not(.e-close) .labelchoose {
        display: none;
    }

    .tailwind3-dark .blockeditor-marked .sidebar-content #left-toc-closebtn {
        background: rgb(73 76 80);
    }

    /* Toolbar layout */
    #mk-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
</style>

@section ActionDescription {
    <div id="action-description">
        <p>
            This sample demonstrates the Markdown templates viewer built with Block Editor,
            complete with a sidebar navigation tree, breadcrumb, and Markdown loading, editing and Download as Markdown
            capabilities.
        </p>
    </div>
}

@section Description {
    <div id="description">
        <p>
            The Block Editor Documentation Preview is a powerful, interactive
            documentation system that combines
            <code>BlockEditor</code> with a collapsible sidebar, tree
            navigation, and Markdown rendering.
            It allows users to view, edit, and download documentation articles
            written in Markdown format.
        </p>
        <p>Key features demonstrated in this sample:</p>
        <ul>
            <li>
                <strong>Sidebar with TreeView Navigation</strong>: Hierarchical menu
                using <code>ejs-treeview</code> to browse documentation sections.
            </li>
            <li>
                <strong>Markdown Loading</strong>: Loads <code>.md</code> files
                from the <code>assets</code> folder via <code>fetch</code>.
            </li>
            <li>
                <strong>Markdown to BlockEditor Conversion</strong>: Uses
                <code>MarkdownConverter</code> and <code>parseHtmlToBlocks()</code> to convert
                Markdown to rich editable blocks.
            </li>
            <li>
                <strong>Download as Markdown</strong>: Export current editor content
                back to clean Markdown using <code>TurndownService</code>.
            </li>
            <li>
                <strong>Dockable & Responsive Sidebar</strong>: Collapsible sidebar with
                smooth open/close animation and mobile-friendly behavior.
            </li>
            <li>
                <strong>Real-time Editing</strong>: Full Block Editor experience â€”
                formatting, lists, code blocks, mentions, slash commands, and more.
            </li>
            <li>
                <strong>Clean UI with Toolbar</strong>: Professional layout with
                breadcrumb and download button using Toolbar and Breadcrumb
                components.
            </li>
        </ul>
        <p>
            This sample serves as a complete template for building internal
            documentation portals, knowledge bases,
            technical wikis, or product guides using the Block
            Editor.
        </p>
    </div>
}
@section Title { <title>ASP.NET MVC BlockEditor - Markdown Block Templates</title> }
@section Header { <h1 class="sb-sample-text">Markdown Block Templates in ASP.NET MVC BlockEditor</h1> }